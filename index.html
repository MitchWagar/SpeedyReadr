<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Servi-Sync Enterprise</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { font-family: Arial, sans-serif; margin:0; background:#eef2f7; }
header { background:#0f172a; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; }
.container { padding:20px; max-width:1100px; margin:auto; }
.card { background:white; padding:20px; border-radius:10px; margin-bottom:20px; box-shadow:0 3px 8px rgba(0,0,0,0.08);}
button { padding:8px 15px; border:none; border-radius:6px; background:#2563eb; color:white; cursor:pointer; }
button:hover { background:#1d4ed8; }
input, select, textarea { width:100%; padding:8px; margin:8px 0; border-radius:6px; border:1px solid #ccc; }
.hidden { display:none; }
.log { border-left:4px solid #2563eb; padding-left:10px; margin-bottom:15px; }
.tabs { display:flex; gap:10px; margin-bottom:10px; }
.tab-button { background:#cbd5e1; color:black; }
.tab-button.active { background:#2563eb; color:white; }
#reader { width:300px; margin-top:10px; }
</style>
</head>

<body>

<header>
<h2>Servi-Sync Enterprise</h2>
<div>
<span id="userDisplay"></span>
<button onclick="logout()">Logout</button>
</div>
</header>

<div class="container">

<div id="loginCard" class="card">
<h3>Login</h3>

<select id="roleSelect" onchange="toggleLoginFields()">
<option value="Tech">Technician</option>
<option value="Supervisor">Supervisor</option>
<option value="Admin">Admin</option>
</select>

<div id="techLogin">
<select id="techSelect"></select>
</div>

<input type="password" id="adminPassword" class="hidden" placeholder="Admin Password">

<button onclick="login()">Login</button>
</div>

<div id="adminPanel" class="hidden">
<div class="card">
<h3>Add Technician</h3>
<input id="newTechName" placeholder="Technician Name">
<input id="newTechPhone" placeholder="Phone Number">
<button onclick="addTechnician()">Add Technician</button>
</div>

<div class="card">
<h3>Add New Machine</h3>
<input id="newMachineId" placeholder="Machine ID">
<button onclick="createMachine()">Create Machine</button>
</div>
</div>

<div id="dashboard" class="hidden">

<div class="card">
<h3>Machine Lookup</h3>
<input id="machineId" placeholder="Enter Machine ID">
<button onclick="startScanner()">Scan QR</button>
<div id="reader" class="hidden"></div>
<button onclick="loadMachine()">Load Machine</button>
</div>

<div id="machineSection" class="hidden">

<div class="tabs">
<button class="tab-button active" onclick="showTab('historyTab', this)">Service History</button>
<button class="tab-button" onclick="showTab('logTab', this)">Log Service</button>
</div>

<div id="historyTab">
<div class="card">
<h3>Service History</h3>
<div id="history"></div>
</div>
</div>

<div id="logTab" class="hidden">
<div class="card">
<h3>Log Service</h3>
<textarea id="details" placeholder="Work Performed"></textarea>
<textarea id="partsUsed" placeholder="Parts Used"></textarea>
<input id="downtime" type="number" placeholder="Downtime (hours)">
<button onclick="addService()">Submit Log</button>
</div>
</div>

</div>
</div>

<script>
const API_BASE = "https://speedyreadr.onrender.com";

let role="";
let currentMachine="";
let scanner=null;
let loggedTech=null;

/* -------- TECHS -------- */

async function populateTechDropdown(){
    const res = await fetch(`${API_BASE}/techs`);
    const techs = await res.json();

    const select = document.getElementById("techSelect");
    select.innerHTML='<option value="">Select Technician</option>';

    techs.forEach(t=>{
        select.innerHTML+=`<option value="${t.id}" data-phone="${t.phone}">${t.name}</option>`;
    });
}

async function addTechnician(){
    const name=newTechName.value;
    const phone=newTechPhone.value;

    await fetch(`${API_BASE}/techs`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({name,phone})
    });

    alert("Technician Added");
    populateTechDropdown();
}

/* -------- LOGIN -------- */

function toggleLoginFields(){
    const selectedRole=roleSelect.value;
    adminPassword.classList.toggle("hidden",selectedRole!=="Admin");
    techLogin.classList.toggle("hidden",selectedRole!=="Tech");
}

function login(){
    role=roleSelect.value;

    if(role==="Admin"){
        if(adminPassword.value!=="1234") return alert("Incorrect Password");
        adminPanel.classList.remove("hidden");
    }

    if(role==="Tech"){
        const selected=techSelect.options[techSelect.selectedIndex];
        if(!selected.value) return alert("Select Technician");
        loggedTech={
            id:selected.value,
            name:selected.text,
            phone:selected.dataset.phone
        };
    }

    loginCard.classList.add("hidden");
    dashboard.classList.remove("hidden");
    userDisplay.innerText=role==="Tech"?`${loggedTech.name} (${loggedTech.phone})`:role;
}

function logout(){ location.reload(); }

/* -------- MACHINE -------- */

async function createMachine(){
    const machine_id=newMachineId.value;

    await fetch(`${API_BASE}/machines`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({machine_id})
    });

    alert("Machine Created");
}

function loadMachine(){
    currentMachine=machineId.value.trim();
    if(!currentMachine) return alert("Enter Machine ID");

    machineSection.classList.remove("hidden");
    displayHistory();
}

/* -------- SERVICE -------- */

async function addService(){
    if(role==="Supervisor") return alert("Supervisors cannot log service");

    await fetch(`${API_BASE}/logs`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            machine_id:currentMachine,
            tech_name:loggedTech.name,
            tech_phone:loggedTech.phone,
            details:details.value,
            parts:partsUsed.value,
            downtime:downtime.value||0
        })
    });

    alert("Service log submitted");
    details.value="";
    partsUsed.value="";
    downtime.value="";
    displayHistory();
}

async function displayHistory(){
    const res = await fetch(`${API_BASE}/logs/${currentMachine}`);
    const logs = await res.json();

    history.innerHTML="";

    logs.forEach(log=>{
        history.innerHTML+=`
        <div class="log">
        <strong>${new Date(log.created_at).toLocaleString()}</strong><br>
        Tech: ${log.tech_name}<br>
        Phone: ${log.tech_phone}<br>
        Downtime: ${log.downtime} hrs<br>
        Work: ${log.details}${log.parts ? "<br>Parts: "+log.parts : ""}
        </div>`;
    });
}

/* -------- TABS -------- */

function showTab(tabId,btn){
    historyTab.classList.add("hidden");
    logTab.classList.add("hidden");
    document.getElementById(tabId).classList.remove("hidden");
    document.querySelectorAll(".tab-button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
}

/* -------- QR -------- */

function startScanner(){
    const reader=document.getElementById("reader");
    reader.classList.remove("hidden");
    scanner=new Html5Qrcode("reader");
    scanner.start(
        {facingMode:"environment"},
        {fps:10,qrbox:250},
        qr=>{
            machineId.value=qr;
            scanner.stop();
            reader.classList.add("hidden");
        }
    );
}

populateTechDropdown();
</script>

</body>
</html>
