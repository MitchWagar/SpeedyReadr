<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Servi-Sync Enterprise</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { font-family: Arial, sans-serif; margin:0; background:#eef2f7; }
header { background:#0f172a; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; }
.container { padding:20px; max-width:1100px; margin:auto; }
.card { background:white; padding:20px; border-radius:10px; margin-bottom:20px; box-shadow:0 3px 8px rgba(0,0,0,0.08);}
button { padding:8px 15px; border:none; border-radius:6px; background:#2563eb; color:white; cursor:pointer; }
button:hover { background:#1d4ed8; }
input, select, textarea { width:100%; padding:8px; margin:8px 0; border-radius:6px; border:1px solid #ccc; }
.hidden { display:none; }
.log { border-left:4px solid #2563eb; padding-left:10px; margin-bottom:15px; }
.tabs { display:flex; gap:10px; margin-bottom:10px; }
.tab-button { background:#cbd5e1; color:black; }
.tab-button.active { background:#2563eb; color:white; }
#reader { width:300px; margin-top:10px; }
</style>
</head>

<body>

<header>
  <h2>Servi-Sync Enterprise</h2>
  <div>
    <span id="userDisplay"></span>
    <button onclick="logout()">Logout</button>
  </div>
</header>

<div class="container">

<!-- LOGIN -->
<div id="loginCard" class="card">
  <h3>Login</h3>

  <select id="roleSelect" onchange="toggleLoginFields()">
    <option value="Tech">Technician</option>
    <option value="Admin">Admin</option>
  </select>

  <div id="techLogin">
    <select id="techSelect">
      <option value="">Select Technician</option>
    </select>
  </div>

  <input type="password" id="adminPassword" class="hidden" placeholder="Admin Password">
  <button onclick="login()">Login</button>
</div>

<!-- ADMIN -->
<div id="adminPanel" class="hidden">
  <div class="card">
    <h3>Add Technician</h3>
    <input id="newTechName" placeholder="Technician Name">
    <input id="newTechPhone" placeholder="Phone Number">
    <button onclick="addTechnician()">Add Technician</button>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">

<div class="card">
  <h3>Machine Lookup</h3>
  <input id="machineId" placeholder="Machine ID">
  <button onclick="startScanner()">Scan QR</button>
  <div id="reader" class="hidden"></div>
  <button onclick="loadMachine()">Load Machine</button>
</div>

<div id="machineSection" class="hidden">

<div class="tabs">
  <button class="tab-button active" onclick="showTab('historyTab', this)">Service History</button>
  <button class="tab-button" onclick="showTab('logTab', this)">Log Service</button>
</div>

<div id="historyTab">
  <div class="card">
    <h3>Service History</h3>
    <div id="history"></div>
  </div>
</div>

<div id="logTab" class="hidden">
  <div class="card">
    <h3>Log Service</h3>
    <textarea id="details" placeholder="Work Performed"></textarea>
    <textarea id="partsUsed" placeholder="Parts Used"></textarea>
    <input id="downtime" type="number" placeholder="Downtime (hours)">
    <button onclick="addService()">Submit Log</button>
  </div>
</div>

</div>
</div>

<script>
/* ================== CONFIG ================== */
const API = "https://speedyreadr.onrender.com";

/* ================== STATE ================== */
let role = "";
let currentMachine = "";
let loggedTech = null;
let scanner = null;

/* ================== TECHS ================== */
async function getTechs() {
  const res = await fetch(API + "/techs");
  return await res.json();
}

async function populateTechDropdown() {
  const select = document.getElementById("techSelect");
  const techs = await getTechs();

  select.innerHTML = '<option value="">Select Technician</option>';

  techs.forEach(t => {
    select.innerHTML += `
      <option value="${t.id}" data-name="${t.name}" data-phone="${t.phone}">
        ${t.name}
      </option>`;
  });
}

async function addTechnician() {
  const name = document.getElementById("newTechName").value.trim();
  const phone = document.getElementById("newTechPhone").value.trim();
  if (!name || !phone) return alert("Name and phone required");

  const res = await fetch(API + "/techs", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, phone })
  });

  if (!res.ok) return alert("Technician already exists");

  alert("Technician added");
  populateTechDropdown();
}

/* ================== LOGIN ================== */
function toggleLoginFields() {
  const roleSel = document.getElementById("roleSelect").value;
  document.getElementById("adminPassword").classList.toggle("hidden", roleSel !== "Admin");
  document.getElementById("techLogin").classList.toggle("hidden", roleSel !== "Tech");
}

function login() {
  role = document.getElementById("roleSelect").value;
  loggedTech = null;

  if (role === "Admin") {
    const pass = document.getElementById("adminPassword").value;
    if (pass !== "1234") return alert("Wrong password");
    document.getElementById("adminPanel").classList.remove("hidden");
  }

  if (role === "Tech") {
    const sel = document.getElementById("techSelect");
    const opt = sel.options[sel.selectedIndex];

    if (!opt || !opt.value) return alert("Select a technician");

    loggedTech = {
      id: opt.value,
      name: opt.dataset.name,
      phone: opt.dataset.phone
    };
  }

  document.getElementById("loginCard").classList.add("hidden");
  document.getElementById("dashboard").classList.remove("hidden");

  document.getElementById("userDisplay").innerText =
    role === "Tech" ? `${loggedTech.name} (${loggedTech.phone})` : role;
}

function logout() {
  location.reload();
}

/* ================== MACHINES ================== */
async function loadMachine() {
  const id = document.getElementById("machineId").value.trim();
  if (!id) return alert("Enter machine ID");

  const res = await fetch(API + "/machines/" + id);
  if (!res.ok) return alert("Machine not found");

  currentMachine = id;
  document.getElementById("machineSection").classList.remove("hidden");
  displayHistory();
}

/* ================== SERVICE ================== */
async function addService() {
  if (role !== "Tech" || !loggedTech) {
    return alert("Must be logged in as technician");
  }

  const details = document.getElementById("details").value.trim();
  if (!details) return alert("Work performed required");

  const res = await fetch(API + "/logs", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      machine_id: currentMachine,
      tech_name: loggedTech.name,
      tech_phone: loggedTech.phone,
      details,
      parts: document.getElementById("partsUsed").value,
      downtime: document.getElementById("downtime").value || 0
    })
  });

  if (!res.ok) return alert("Failed to log service");

  document.getElementById("details").value = "";
  document.getElementById("partsUsed").value = "";
  document.getElementById("downtime").value = "";

  displayHistory();
}

async function displayHistory() {
  const res = await fetch(API + "/logs/" + currentMachine);
  const logs = await res.json();
  const history = document.getElementById("history");

  history.innerHTML = "";
  logs.forEach(l => {
    history.innerHTML += `
      <div class="log">
        <strong>${new Date(l.date).toLocaleString()}</strong><br>
        Tech: ${l.tech_name}<br>
        Phone: ${l.tech_phone}<br>
        Downtime: ${l.downtime} hrs<br>
        Work: ${l.details}
      </div>`;
  });
}

/* ================== QR ================== */
function startScanner() {
  const reader = document.getElementById("reader");
  reader.classList.remove("hidden");

  scanner = new Html5Qrcode("reader");
  scanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    qr => {
      document.getElementById("machineId").value = qr;
      scanner.stop();
      reader.classList.add("hidden");
    }
  );
}

/* ================== INIT ================== */
populateTechDropdown();
</script>

</body>
</html>
