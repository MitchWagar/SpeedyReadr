<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Servi-Sync Enterprise</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { font-family: Arial, sans-serif; margin:0; background:#eef2f7; }
header { background:#0f172a; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; }
.container { padding:20px; max-width:1100px; margin:auto; }
.card { background:white; padding:20px; border-radius:10px; margin-bottom:20px; box-shadow:0 3px 8px rgba(0,0,0,0.08);}
button { padding:8px 15px; border:none; border-radius:6px; background:#2563eb; color:white; cursor:pointer; }
button:hover { background:#1d4ed8; }
input, select, textarea { width:100%; padding:8px; margin:8px 0; border-radius:6px; border:1px solid #ccc; }
.hidden { display:none; }
.log { border-left:4px solid #2563eb; padding-left:10px; margin-bottom:15px; }
.tabs { display:flex; gap:10px; margin-bottom:10px; }
.tab-button { background:#cbd5e1; color:black; }
.tab-button.active { background:#2563eb; color:white; }
#reader { width:300px; margin-top:10px; }
</style>
</head>

<body>

<header>
<h2>Servi-Sync Enterprise</h2>
<div>
<span id="userDisplay"></span>
<button onclick="logout()">Logout</button>
</div>
</header>

<div class="container">

<!-- LOGIN -->
<div id="loginCard" class="card">
<h3>Login</h3>

<select id="roleSelect" onchange="toggleLoginFields()">
<option value="Tech">Technician</option>
<option value="Supervisor">Supervisor</option>
<option value="Admin">Admin</option>
</select>

<div id="techLogin">
<select id="techSelect"></select>
</div>

<input type="password" id="adminPassword" class="hidden" placeholder="Admin Password">
<button onclick="login()">Login</button>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" class="hidden">

<div class="card">
<h3>Manage Technicians</h3>
<select id="adminTechSelect"></select>
<input id="editTechName" placeholder="Name">
<input id="editTechPhone" placeholder="Phone">
<button onclick="updateTechnician()">Update Technician</button>
<button onclick="deleteTechnician()">Delete Technician</button>
</div>

<div class="card">
<h3>Add Technician</h3>
<input id="newTechName" placeholder="Technician Name">
<input id="newTechPhone" placeholder="Phone Number">
<button onclick="addTechnician()">Add Technician</button>
</div>

<div class="card">
<h3>Manage Machines</h3>
<input id="editMachineId" placeholder="Machine ID">
<input id="editAirport" placeholder="Airport">
<input id="editTerminal" placeholder="Terminal">
<input id="editCheckpoint" placeholder="Checkpoint">
<input id="editLane" placeholder="Lane">
<textarea id="editNotes" placeholder="Notes"></textarea>
<button onclick="updateMachine()">Update Machine</button>
<button onclick="deleteMachine()">Delete Machine</button>
</div>

<div class="card">
<h3>Add New Machine</h3>
<input id="newMachineId" placeholder="Machine ID">
<input id="airport" placeholder="Airport">
<input id="terminal" placeholder="Terminal">
<input id="checkpoint" placeholder="Checkpoint">
<input id="lane" placeholder="Lane">
<textarea id="notes" placeholder="Position Notes"></textarea>
<button onclick="createMachine()">Create Machine</button>
</div>

</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">

<div class="card">
<h3>Machine Lookup</h3>
<input id="machineId" placeholder="Enter Machine ID">
<button onclick="startScanner()">Scan QR</button>
<div id="reader" class="hidden"></div>
<button onclick="loadMachine()">Load Machine</button>
</div>

<div id="machineSection" class="hidden">

<div class="tabs">
<button class="tab-button active" onclick="showTab('historyTab',this)">Service History</button>
<button class="tab-button" onclick="showTab('logTab',this)">Log Service</button>
<button class="tab-button" onclick="showTab('locationTab',this)">Location</button>
</div>

<div id="historyTab">
<div class="card"><div id="history"></div></div>
</div>

<div id="logTab" class="hidden">
<div class="card">
<textarea id="details" placeholder="Work Performed"></textarea>
<textarea id="partsUsed" placeholder="Parts Used"></textarea>
<input id="downtime" type="number" placeholder="Downtime (hours)">
<button onclick="addService()">Submit Log</button>
</div>
</div>

<div id="locationTab" class="hidden">
<div class="card"><div id="locationDisplay"></div></div>
</div>

</div>
</div>

<script>
const API="https://speedyreadr.onrender.com";
let role="",currentMachine="",loggedTech=null,scanner=null;

async function getTechs(){
    const r=await fetch(API+"/techs");return r.json();
}

async function populateTechDropdown(){
    const t=await getTechs();
    techSelect.innerHTML='<option value="">Select Technician</option>';
    t.forEach(x=>techSelect.innerHTML+=`<option value="${x.id}" data-name="${x.name}" data-phone="${x.phone}">${x.name}</option>`);
}

async function populateAdminTechs(){
    const t=await getTechs();
    adminTechSelect.innerHTML="";
    t.forEach(x=>adminTechSelect.innerHTML+=`<option value="${x.id}" data-name="${x.name}" data-phone="${x.phone}">${x.name}</option>`);
    adminTechSelect.onchange=()=>{
        const o=adminTechSelect.options[adminTechSelect.selectedIndex];
        editTechName.value=o.dataset.name;
        editTechPhone.value=o.dataset.phone;
    };
    adminTechSelect.dispatchEvent(new Event("change"));
}

async function addTechnician(){
    await fetch(API+"/techs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:newTechName.value,phone:newTechPhone.value})});
    populateTechDropdown();populateAdminTechs();
}

async function updateTechnician(){
    await fetch(API+"/techs/"+adminTechSelect.value,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:editTechName.value,phone:editTechPhone.value})});
    alert("Updated");populateTechDropdown();populateAdminTechs();
}

async function deleteTechnician(){
    if(!confirm("Delete technician?"))return;
    await fetch(API+"/techs/"+adminTechSelect.value,{method:"DELETE"});
    populateTechDropdown();populateAdminTechs();
}

function toggleLoginFields(){
    adminPassword.classList.toggle("hidden",roleSelect.value!=="Admin");
    techLogin.classList.toggle("hidden",roleSelect.value!=="Tech");
}

function login(){
    role=roleSelect.value;
    if(role==="Admin"&&adminPassword.value!=="1234")return alert("Bad password");
    if(role==="Tech"){
        const o=techSelect.options[techSelect.selectedIndex];
        loggedTech={name:o.dataset.name,phone:o.dataset.phone};
    }
    loginCard.classList.add("hidden");
    dashboard.classList.remove("hidden");
    if(role==="Admin"){adminPanel.classList.remove("hidden");populateAdminTechs();}
    userDisplay.innerText=role;
}

function logout(){location.reload();}

async function createMachine(){
    await fetch(API+"/machines",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({machine_id:newMachineId.value,airport:airport.value,terminal:terminal.value,checkpoint:checkpoint.value,lane:lane.value,notes:notes.value})});
    alert("Machine created");
}

async function updateMachine(){
    await fetch(API+"/machines/"+editMachineId.value,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({airport:editAirport.value,terminal:editTerminal.value,checkpoint:editCheckpoint.value,lane:editLane.value,notes:editNotes.value})});
    alert("Machine updated");
}

async function deleteMachine(){
    if(!confirm("Delete machine + logs?"))return;
    await fetch(API+"/machines/"+editMachineId.value,{method:"DELETE"});
    alert("Deleted");
}

populateTechDropdown();
</script>

</body>
</html>
