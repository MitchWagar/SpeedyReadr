<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Servi-Sync Enterprise</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
/* basic styling */
body { font-family: Arial, sans-serif; margin:0; background:#eef2f7; }
header { background:#0f172a; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; }
.container { padding:20px; max-width:1100px; margin:auto; }
.card { background:white; padding:20px; border-radius:10px; margin-bottom:20px; box-shadow:0 3px 8px rgba(0,0,0,0.08);}
button { padding:8px 15px; border:none; border-radius:6px; background:#2563eb; color:white; cursor:pointer; }
button:hover { background:#1d4ed8; }
input, select, textarea { width:100%; padding:8px; margin:8px 0; border-radius:6px; border:1px solid #ccc; }
.hidden { display:none; }
.log { border-left:4px solid #2563eb; padding-left:10px; margin-bottom:15px; }
.tabs { display:flex; gap:10px; margin-bottom:10px; }
.tab-button { background:#cbd5e1; color:black; }
.tab-button.active { background:#2563eb; color:white; }
#reader { width:300px; margin-top:10px; }
</style>
</head>
<body>

<header>
<h2>Servi-Sync Enterprise</h2>
<div>
<span id="userDisplay"></span>
<button onclick="logout()">Logout</button>
</div>
</header>

<div class="container">

<!-- LOGIN -->
<div id="loginCard" class="card">
<h3>Login</h3>
<select id="roleSelect" onchange="toggleLoginFields()">
<option value="Tech">Technician</option>
<option value="Supervisor">Supervisor</option>
<option value="Admin">Admin</option>
</select>

<div id="techLogin">
<select id="techSelect">
<option value="">Select Technician</option>
</select>
</div>

<input type="password" id="adminPassword" class="hidden" placeholder="Admin Password">
<button onclick="login()">Login</button>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" class="hidden">

<div class="card">
<h3>Add Technician</h3>
<input id="newTechName" placeholder="Technician Name">
<input id="newTechPhone" placeholder="Phone Number">
<button onclick="addTechnician()">Add Technician</button>
</div>

<div class="card">
<h3>Add New Machine</h3>
<input id="newMachineId" placeholder="Machine ID">
<input id="airport" placeholder="Airport">
<input id="terminal" placeholder="Terminal">
<input id="checkpoint" placeholder="Checkpoint">
<input id="lane" placeholder="Lane">
<textarea id="notes" placeholder="Position Notes"></textarea>
<button onclick="createMachine()">Create Machine</button>
</div>

<div class="card">
    <h3>Manage Technicians</h3>
    <div id="techList"></div>
</div>

<div class="card">
    <h3>Manage Machines</h3>
    <div id="machineList"></div>
</div>

</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">

<div class="card">
<h3>Machine Lookup</h3>
<input id="machineId" placeholder="Enter Machine ID">
<button onclick="startScanner()">Scan QR</button>
<div id="reader" class="hidden"></div>
<button onclick="loadMachine()">Load Machine</button>
</div>

<div id="machineSection" class="hidden">

<div class="tabs">
<button class="tab-button active" onclick="showTab('historyTab', this)">Service History</button>
<button class="tab-button" onclick="showTab('logTab', this)">Log Service</button>
<button class="tab-button" onclick="showTab('locationTab', this)">Location</button>
</div>

<!-- HISTORY TAB -->
<div id="historyTab">
<div class="card">
<h3>Service History</h3>
<div id="history"></div>
</div>
</div>

<!-- LOG SERVICE TAB -->
<div id="logTab" class="hidden">
<div class="card">
<h3>Log Service</h3>
<textarea id="details" placeholder="Work Performed"></textarea>
<textarea id="partsUsed" placeholder="Parts Used"></textarea>
<input id="downtime" type="number" placeholder="Downtime (hours)">
<button onclick="addService()">Submit Log</button>
</div>
</div>

<!-- LOCATION TAB -->
<div id="locationTab" class="hidden">
<div class="card">
<h3>Current Location</h3>
<div id="locationDisplay"></div>
</div>

<div class="card">
<h3>Update Location (If Moved)</h3>
<input id="updateAirport" placeholder="Airport">
<input id="updateTerminal" placeholder="Terminal">
<input id="updateCheckpoint" placeholder="Checkpoint">
<input id="updateLane" placeholder="Lane">
<textarea id="updateNotes" placeholder="Position Notes"></textarea>
<button onclick="updateLocation()">Update Location</button>
</div>
</div>

</div>
</div>

<script>
const API = "https://speedyreadr.onrender.com"; // replace with your server URL
let role="", currentMachine="", loggedTech=null, scanner=null;

// ---------- TECH ----------
async function getTechs() {
    const res = await fetch(API+"/techs");
    return await res.json(); // [{id,name,phone}, ...]
}

async function populateTechDropdown(){
    const select = document.getElementById("techSelect");
    const techs = await getTechs();
    select.innerHTML = '<option value="">Select Technician</option>';
    techs.forEach(t=>{
        select.innerHTML += `<option value="${t.id}" data-name="${t.name}" data-phone="${t.phone}">${t.name}</option>`;
    });
    displayTechnicians();
}

async function addTechnician(){
    const name=document.getElementById("newTechName").value;
    const phone=document.getElementById("newTechPhone").value;
    if(!name||!phone) return alert("Name and phone required");
    const res = await fetch(API+"/techs", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({name,phone})
    });
    const data = await res.json();
    alert("Technician Added: "+data.name);
    populateTechDropdown();
}

// ---------- LOGIN ----------
function toggleLoginFields(){
    const selectedRole=document.getElementById("roleSelect").value;
    document.getElementById("adminPassword").classList.toggle("hidden",selectedRole!=="Admin");
    document.getElementById("techLogin").classList.toggle("hidden",selectedRole!=="Tech");
}

function login(){
    role=document.getElementById("roleSelect").value;

    if(role==="Admin"){
        const pass=document.getElementById("adminPassword").value;
        if(pass!=="1234") return alert("Incorrect Password");
        document.getElementById("adminPanel").classList.remove("hidden");
    }

    if(role==="Tech"){
        const sel=document.getElementById("techSelect");
        const option = sel.options[sel.selectedIndex];
        if(!option.value) return alert("Select Technician");
        loggedTech = { name: option.dataset.name, phone: option.dataset.phone };
    }

    document.getElementById("loginCard").classList.add("hidden");
    document.getElementById("dashboard").classList.remove("hidden");
    document.getElementById("userDisplay").innerText = role==="Tech"?`${loggedTech.name} (${loggedTech.phone})`:role;
}

function logout(){ currentMachine=""; location.reload(); }

// ---------- MACHINES ----------
async function getMachines() {
    const res = await fetch(API+"/machines");
    return await res.json();
}

async function displayMachines() {
    const machineList = document.getElementById("machineList");
    const machines = await getMachines();
    
    machineList.innerHTML = machines.map(machine => `
        <div class="card" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div>
                <strong>Machine ID: ${machine.machine_id}</strong><br>
                Airport: ${machine.airport || 'N/A'}<br>
                Terminal: ${machine.terminal || 'N/A'}
            </div>
            <div>
                <button onclick="editMachine('${machine.machine_id}')" style="background:#f59e0b; margin-right:5px;">Edit</button>
                <button onclick="deleteMachine('${machine.machine_id}')" style="background:#ef4444;">Delete</button>
            </div>
        </div>
    `).join('');
}

async function createMachine(){
    const machine_id=document.getElementById("newMachineId").value.trim();
    if(!machine_id) return alert("Machine ID required");
    const data = {
        machine_id,
        airport: document.getElementById("airport").value,
        terminal: document.getElementById("terminal").value,
        checkpoint: document.getElementById("checkpoint").value,
        lane: document.getElementById("lane").value,
        notes: document.getElementById("notes").value
    };
    const res = await fetch(API+"/machines", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(data)
    });
    const result = await res.json();
    if(result.error) return alert(result.error);
    alert("Machine Created: "+result.machine_id);
    displayMachines();
}

async function loadMachine(){
    const id=document.getElementById("machineId").value.trim();
    if(!id) return alert("Enter a Machine ID");
    const res = await fetch(API+"/machines/"+id);
    if(res.status!==200) return alert("Machine not found");
    currentMachine=id;
    document.getElementById("machineSection").classList.remove("hidden");
    displayHistory();
    loadLocation();
}

// ---------- SERVICE ----------
async function getLogs(){
    if(!currentMachine) return [];
    const res = await fetch(API+"/logs/"+currentMachine);
    return await res.json();
}

async function addService(){
    if(role==="Supervisor") return alert("Supervisors cannot log service");
    if(!currentMachine) return alert("Load a machine first");
    const data = {
        machine_id: currentMachine,
        tech_name: loggedTech?.name || "N/A",
        tech_phone: loggedTech?.phone || "N/A",
        details: document.getElementById("details").value,
        parts: document.getElementById("partsUsed").value,
        downtime: document.getElementById("downtime").value || 0
    };
    const res = await fetch(API+"/logs", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(data)
    });
    await res.json();
    alert("Service log submitted!");
    document.getElementById("details").value="";
    document.getElementById("partsUsed").value="";
    document.getElementById("downtime").value="";
    displayHistory();
}

async function displayHistory(){
    const history=document.getElementById("history");
    history.innerHTML="";
    const logs=await getLogs();
    logs.forEach(log=>{
        history.innerHTML+=`
        <div class="log">
        <strong>${new Date(log.date).toLocaleString()}</strong><br>
        Tech: ${log.tech_name}<br>
        Phone: ${log.tech_phone}<br>
        Downtime: ${log.downtime} hrs<br>
        Work: ${log.details}${log.parts ? "<br>Parts: "+log.parts : "" }
        </div>`;
    });
}

// ---------- LOCATION ----------
async function loadLocation(){
    const res = await fetch(API+"/machines/"+currentMachine);
    const data = await res.json();
    const display=document.getElementById("locationDisplay");
    if(!data) return display.innerHTML="No location set.";
    display.innerHTML=`Airport: ${data.airport}<br>Terminal: ${data.terminal}<br>Checkpoint: ${data.checkpoint}<br>Lane: ${data.lane}<br>Notes: ${data.notes}`;
}

async function updateLocation(){
    const oldRes = await fetch(API+"/machines/"+currentMachine);
    const oldData = await oldRes.json();
    const newData = {
        airport: document.getElementById("updateAirport").value,
        terminal: document.getElementById("updateTerminal").value,
        checkpoint: document.getElementById("updateCheckpoint").value,
        lane: document.getElementById("updateLane").value,
        notes: document.getElementById("updateNotes").value
    };
    await fetch(API+"/machines/"+currentMachine+"/location", {
        method:"PUT",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(newData)
    });
    // Log location update
    const details = `Moved from Airport: ${oldData.airport}, Terminal: ${oldData.terminal}, Checkpoint: ${oldData.checkpoint}, Lane: ${oldData.lane}, Notes: ${oldData.notes} To Airport: ${newData.airport}, Terminal: ${newData.terminal}, Checkpoint: ${newData.checkpoint}, Lane: ${newData.lane}, Notes: ${newData.notes}`;
    await fetch(API+"/logs", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({
            machine_id: currentMachine,
            tech_name: loggedTech?.name || "N/A",
            tech_phone: loggedTech?.phone || "N/A",
            details,
            parts:"",
            downtime:0
        })
    });
    alert("Location updated and logged in history");
    loadLocation();
    displayHistory();
}

// ---------- TABS ----------
function showTab(tabId,btn){
    document.getElementById("historyTab").classList.add("hidden");
    document.getElementById("logTab").classList.add("hidden");
    document.getElementById("locationTab").classList.add("hidden");
    document.getElementById(tabId).classList.remove("hidden");
    document.querySelectorAll(".tab-button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
}

// ---------- QR ----------
function startScanner(){
    const reader=document.getElementById("reader");
    reader.classList.remove("hidden");
    scanner=new Html5Qrcode("reader");
    scanner.start(
        {facingMode:"environment"},
        {fps:10,qrbox:250},
        qr=>{
            document.getElementById("machineId").value=qr;
            scanner.stop();
            reader.classList.add("hidden");
        }
    );
}

// ---------- TECHNICIAN MANAGEMENT ----------
async function displayTechnicians() {
    const techList = document.getElementById("techList");
    const techs = await getTechs();
    
    techList.innerHTML = techs.map(tech => `
        <div class="card" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div>
                <strong>${tech.name}</strong> - ${tech.phone}
            </div>
            <div>
                <button onclick="editTechnician(${tech.id})" style="background:#f59e0b; margin-right:5px;">Edit</button>
                <button onclick="deleteTechnician(${tech.id})" style="background:#ef4444;">Delete</button>
            </div>
        </div>
    `).join('');
}

async function editTechnician(id) {
    const techs = await getTechs();
    const tech = techs.find(t => t.id === id);
    
    const newName = prompt("Edit Technician Name:", tech.name);
    const newPhone = prompt("Edit Phone Number:", tech.phone);
    
    if (newName && newPhone) {
        const res = await fetch(API+"/techs/" + id, {
            method: "PUT",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({name: newName, phone: newPhone})
        });
        
        if (res.ok) {
            alert("Technician updated successfully!");
            displayTechnicians();
            populateTechDropdown();
        } else {
            alert("Failed to update technician");
        }
    }
}

async function deleteTechnician(id) {
    if (!confirm("Are you sure you want to delete this technician?")) return;
    
    const res = await fetch(API+"/techs/" + id, {
        method: "DELETE"
    });
    
    if (res.ok) {
        alert("Technician deleted successfully!");
        displayTechnicians();
        populateTechDropdown();
    } else {
        alert("Failed to delete technician");
    }
}

// ---------- MACHINE MANAGEMENT ----------
async function editMachine(machineId) {
    const res = await fetch(API+"/machines/" + machineId);
    const machine = await res.json();
    
    const newAirport = prompt("Edit Airport:", machine.airport || '');
    const newTerminal = prompt("Edit Terminal:", machine.terminal || '');
    const newCheckpoint = prompt("Edit Checkpoint:", machine.checkpoint || '');
    const newLane = prompt("Edit Lane:", machine.lane || '');
    const newNotes = prompt("Edit Notes:", machine.notes || '');
    
    if (newAirport !== null || newTerminal !== null || newCheckpoint !== null || newLane !== null || newNotes !== null) {
        const res = await fetch(API+"/machines/" + machineId, {
            method: "PUT",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({
                airport: newAirport,
                terminal: newTerminal,
                checkpoint: newCheckpoint,
                lane: newLane,
                notes: newNotes
            })
        });
        
        if (res.ok) {
            alert("Machine updated successfully!");
            displayMachines();
        } else {
            alert("Failed to update machine");
        }
    }
}

async function deleteMachine(machineId) {
    if (!confirm("Are you sure you want to delete this machine?")) return;
    
    const res = await fetch(API+"/machines/" + machineId, {
        method: "DELETE"
    });
    
    if (res.ok) {
        alert("Machine deleted successfully!");
        displayMachines();
    } else {
        alert("Failed to delete machine");
    }
}

// ---------- INIT ----------
populateTechDropdown();
displayMachines();
</script>
</body>
</html>

